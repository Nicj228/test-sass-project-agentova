---
description: RÃ¨gles globales du projet (conventions, types, workspace, mÃ©tier)
globs: ["**/*.ts", "**/*.tsx"]
alwaysApply: true
---

# ğŸŒ RÃˆGLES GLOBALES COMPLÃˆTES

## ğŸ”„ WORKSPACE-CENTRIC RULES NON-NÃ‰GOCIABLES
- âœ… **workspace_id** TOUJOURS en premier paramÃ¨tre
- âœ… **WHERE workspace_id = $1** dans TOUTES les requÃªtes
- âœ… **Token validation** Ã  chaque appel API
- âœ… **Isolation complÃ¨te** entre workspaces
- âœ… **getCurrentWorkspaceId** via useWorkspaceContext()
- âœ… **WORKSPACE_ROLES.ADMIN** pour actions sensibles
- âœ… **WORKSPACE_ROLES.EDITOR** pour actions standard
- âœ… **VÃ©rification rÃ´les** avant actions critiques
- âœ… **Error handling** pour permissions insuffisantes

## ğŸš¨ RÃˆGLES CRITIQUES ABSOLUES - VIOLATIONS BLOQUANTES

### âš ï¸ ENUM OBLIGATOIRE - JAMAIS DE STRINGS
```typescript
// âŒ INTERDIT - Types avec strings
type Status = 'pending' | 'completed' | 'failed';

// âœ… OBLIGATOIRE - Enum pour traÃ§abilitÃ©
enum Status {
  PENDING = 'pending',
  COMPLETED = 'completed', 
  FAILED = 'failed'
}
```

### ğŸ“ TYPES DANS SHARED/TYPES.TS
- âœ… **Tous les types** dans `shared/types.ts`
- âœ… **Types services** dans le service lui-mÃªme SEULEMENT si spÃ©cifique
- âŒ **JAMAIS** de types dans repositories
- âœ… **Enums** systÃ©matiques pour valeurs fixes

### ğŸ¨ ICONES & ASSETS RULES
- âŒ **JAMAIS** de SVG en dur dans le code
- âœ… **TOUJOURS** utiliser React Icons : https://react-icons.github.io/react-icons/
- âœ… **Import** : `import { RiImageAddLine } from 'react-icons/ri'`
- âœ… **Usage** : `<RiImageAddLine className="w-5 h-5" />`

### ğŸ• DATE MANAGEMENT RULES
- âœ… **TOUJOURS** utiliser `DateService` centralisÃ©
- âœ… **Methods** : `formatChatDate()`, `formatSessionDate()`, `normalizeToMidnightGMT()`
- âœ… **Cache normalisÃ©** : Dates Ã  minuit GMT pour Ã©viter requÃªtes multiples
- âŒ **JAMAIS** crÃ©er de nouvelles fonctions de date
- âŒ **JAMAIS** utiliser Date objects directement dans queryKeys

### ğŸ“ SERVICES LOCAUX EXISTANTS Ã€ UTILISER
```typescript
// âœ… Services Ã  connaitre AVANT de crÃ©er quoi que ce soit
import { DateService } from '@/services/local/dateService';
import { FileProcessingService, FileValidationConfigType } from '@/services/local/fileProcessingService';
import { getFileType, getFileIcon } from '@/services/local/mimeTypeService';
import { DataExportService, EXPORT_FORMATS } from '@/services/local/dataExportService';
import { callSecuredFunction, callSecuredSSEFunction } from '@/services/local/authenticationService';

// âœ… TOUJOURS vÃ©rifier ces services avant crÃ©ation
```

## ğŸ“ CONVENTIONS STRICTES

### Nommage Files
- Services: `{domain}Service.ts` (ex: `replyCommentService.ts`)
- Hooks: `use{Domain}.ts` (ex: `useReplyComments.ts`)
- Components: `PascalCase.tsx` (ex: `ReplyInteraction.tsx`)
- Repositories: `{entity}Repository.ts` (ex: `replyCommentRepository.ts`)
- Types: Interfaces en `PascalCase`
- Constants: `UPPER_SNAKE_CASE`

### TypeScript Rules Globales
- âœ… **Props TOUJOURS typÃ©es** avec interface explicite
- âœ… **Pas de `any`** - utiliser `unknown` si nÃ©cessaire
- âœ… **Types partagÃ©s** de `shared/types.ts`
- âœ… **Enums** pour valeurs fixes (`AutomationName`, `WorkspaceRole`)
- âœ… **Types de retour** explicites pour fonctions publiques
- âœ… **Generics** pour rÃ©utilisabilitÃ©

## ğŸ¯ RÃˆGLES SPÃ‰CIFIQUES MÃ‰TIER

### Custom Agents Rules
- âœ… **Types CustomAgent** : Utiliser `SharedCustomAgent` + extension client si nÃ©cessaire
- âœ… **CustomAgentType** : SAV/SALES obligatoire avec enum
- âœ… **Documents liÃ©s** : Relation via `CustomAgentDocument` 
- âœ… **Sessions** : Extension cÃ´tÃ© client avec `sessions?: Session[]`
- âœ… **Configuration** : `encodeCustomAgentConfig` / `decodeCustomAgentConfig`

### OAuth & Automation Rules
- âœ… **OAuthProvider** : Enum strict (instagram, facebook, google, etc.)
- âœ… **AutomationName** : Enum strict (messages, comments)
- âœ… **Provider isolation** : Un token = un provider + un workspace
- âœ… **Webhooks** : Pattern Meta (200 immÃ©diat + traitement async)
- âœ… **Token refresh** : Gestion automatique avec `refreshTokenIfNeeded`

### Campaign Rules
- âœ… **Structure** : Campaign + CampaignPost[] obligatoire
- âœ… **Images** : MessageFileInline[] avec validation types
- âœ… **Providers** : Support multi-plateforme (Instagram/Facebook)
- âœ… **Ã‰tats** : Draft/Published avec timestamps
- âœ… **Pagination** : CampaignCursor pour grandes listes

### Document & Knowledge Rules
- âœ… **Types documents** : info/url/file/image avec enum
- âœ… **Upload progression** : UploadProgress + UploadStep
- âœ… **Validation taille** : Selon type de fichier
- âœ… **Storage** : Wasabi S3 avec organisation workspace
- âœ… **Corpus integration** : Liens avec custom agents

### Lead Management Rules
- âœ… **Champs dynamiques** : LeadFormField[] configurable
- âœ… **Types supportÃ©s** : text/email/tel/textarea
- âœ… **Validation** : Required fields + formats
- âœ… **Agent association** : Lead â†’ CustomAgent obligatoire
- âœ… **DonnÃ©es RGPD** : Anonymisation possible

### Image Generation Rules
- âœ… **Types gÃ©nÃ©ration** : simple/imageToImage/inpaint/background
- âœ… **ParamÃ¨tres** : BaseGenerationParams + spÃ©cifiques
- âœ… **Formats** : Support WebP/PNG/JPEG
- âœ… **Ratios** : AspectRatio avec validation
- âœ… **Upload temporaire** : Auto-suppression R2

### Session & Chat Rules
- âœ… **Structure messages** : author (user/agent) + timestamp
- âœ… **Types contenu** : text + files optionnels
- âœ… **Outils** : usedTools tracking
- âœ… **Ã‰tats** : isError + partial pour streaming
- âœ… **Pagination** : SessionCursor avec limites

### Notification & Reply Rules
- âœ… **Auto-reply** : first_messages + matching_messages
- âœ… **Pattern matching** : match_phrase â†’ reply_message
- âœ… **Multi-plateforme** : Instagram + Facebook comments
- âœ… **DÃ©lais** : Max 7 jours pour commentaires
- âœ… **Messages privÃ©s** : Auto-redirect vers agent



## ğŸŒ¿ GIT WORKFLOW RULES
- âœ… **TOUJOURS** crÃ©er une nouvelle branche pour toute modification

## ğŸ§¹ CODE QUALITY RULES
- âœ… **Variables utilisÃ©es** - Supprimer variables non utilisÃ©es
- âœ… **Imports organisÃ©s** - Supprimer imports inutiles
- âœ… **Validation push** - Fichier validation post-commit
- âœ… **Enum tracing** - Meilleure traÃ§abilitÃ© que strings

## ğŸ” PRE-DEVELOPMENT CHECKLIST
1. **Enum check** - CrÃ©er enums pour toutes valeurs fixes
2. **Types check** - Ajouter dans shared/types.ts
3. **Services check** - VÃ©rifier services locaux existants
4. **Date check** - Utiliser DateService pour dates
5. **Icon check** - Utiliser React Icons
6. **Validation check** - CrÃ©er fichier validation sÃ©parÃ©
7. **Repository check** - Isolation workspace obligatoire

## ğŸ¯ SANCTIONS POUR NON-RESPECT
- **Erreur critique** : Refus PR automatique
- **Pattern non respectÃ©** : Correction obligatoire
- **SÃ©curitÃ©** : Review sÃ©curitÃ© avant merge
- **Performance** : Benchmarks obligatoires

## ğŸ” POINTS DE CONTRÃ”LE OBLIGATOIRES
1. **Services** : MÃ©thodes statiques + workspaceId premier
2. **Firebase** : Validation auth + workspace + rÃ´les
3. **Types** : Props typÃ©es + shared types utilisÃ©s
4. **SÃ©curitÃ©** : Pas de hardcoding + validation inputs
5. **Performance** : useCallback + React Query optimisÃ©

