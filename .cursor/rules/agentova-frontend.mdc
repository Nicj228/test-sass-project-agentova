---
description: Toutes les rÃ¨gles frontend React/Next.js du projet
globs: ["client/**/*.ts", "client/**/*.tsx"]
alwaysApply: true
---

# âš›ï¸ RÃˆGLES FRONTEND COMPLÃˆTES

## ğŸ—ï¸ ARCHITECTURE FRONTEND OBLIGATOIRE
- **Services** : Classes avec mÃ©thodes statiques UNIQUEMENT + `workspaceId` premier paramÃ¨tre + `callSecuredFunction`
- **Hooks** : `useWorkspaceContext()` + React Query + Return organisÃ© + `useCallback` stabilisÃ©
- **Components** : Props typÃ©es + Interface explicite + `useCallback` handlers + Effects isolÃ©s
- **Contexts** : Ã‰tat minimal + Providers + `useCallback` pour setters + `useMemo` pour valeurs

## ğŸš« ANTI-PATTERNS FRONTEND INTERDITS
- âŒ **Appels API directs** dans composants (utiliser services)
- âŒ **Ã‰tat dans classes de service** (statiques uniquement)
- âŒ **MÃ©thodes d'instance** dans services
- âŒ **Components sans props typÃ©es**
- âŒ **Effects avec multiples responsabilitÃ©s**
- âŒ **Handlers sans useCallback**
- âŒ **Context values sans useMemo**
- âŒ **Query keys hardcodÃ©es** (utiliser queryKeys.*)
- âŒ **Variables non utilisÃ©es** (imports/variables inutiles)
- âŒ **Types any** (utiliser types spÃ©cifiques)

## âœ… SERVICE FRONTEND PATTERN OBLIGATOIRE
```typescript
export class DomainService {
  // âœ… MÃ©thodes statiques uniquement
  static async methodName(
    workspaceId: string, // âœ… Premier paramÃ¨tre TOUJOURS
    params: TypedParams   // âœ… Types explicites
  ): Promise<ReturnType> {
    try {
      return await callSecuredFunction<ReturnType>(
        'functionName',
        workspaceId,
        params
      );
    } catch (error) {
      throw error; // âœ… Rethrow pour gestion niveau hook
    }
  }
}
```

## âœ… HOOK FRONTEND PATTERN OBLIGATOIRE
```typescript
export function useDomain() {
  // âœ… Context workspace obligatoire
  const { currentWorkspaceId } = useWorkspaceContext();
  const queryClient = useQueryClient();

  // âœ… React Query avec clÃ©s standardisÃ©es
  const query = useQuery({
    queryKey: queryKeys.domain(currentWorkspaceId),
    queryFn: () => DomainService.get(currentWorkspaceId),
    staleTime: 0,
    refetchOnMount: true,
    placeholderData: (previousData) => previousData
  });

  // âœ… Mutations avec gestion cache
  const mutation = useMutation({
    mutationFn: (data: InputType) => 
      DomainService.update(currentWorkspaceId, data),
    onSuccess: (updatedData) => {
      queryClient.setQueryData(
        queryKeys.domain(currentWorkspaceId),
        updatedData
      );
    }
  });

  // âœ… Fonctions utilitaires avec useCallback
  const refresh = useCallback(async () => {
    await queryClient.invalidateQueries({
      queryKey: queryKeys.domain(currentWorkspaceId)
    });
  }, [currentWorkspaceId, queryClient]);

  // âœ… Return organisÃ© par catÃ©gorie
  return {
    // Data
    data: query.data,
    // Loading states
    isLoading: query.isLoading,
    isRefetching: query.isRefetching,
    isError: query.isError,
    // Actions
    update: mutation.mutate,
    isUpdating: mutation.isPending,
    // Utils
    refresh
  };
}
```



## âœ… CONTEXT FRONTEND PATTERN OBLIGATOIRE
```typescript
interface ContextType {
  // âœ… Types explicites
  value: string;
  setValue: (value: string) => void;
  isLoading: boolean;
}

const Context = createContext<ContextType | undefined>(undefined);

export function ContextProvider({ children }: { children: ReactNode }) {
  const [value, setValue] = useState<string>('');
  const [isLoading, setIsLoading] = useState(false);

  // âœ… Handlers stabilisÃ©s avec useCallback
  const stableSetValue = useCallback((newValue: string) => {
    setValue(newValue);
  }, []);

  // âœ… Valeur stabilisÃ©e avec useMemo
  const contextValue = useMemo(() => ({
    value,
    setValue: stableSetValue,
    isLoading
  }), [value, stableSetValue, isLoading]);

  return (
    <Context.Provider value={contextValue}>
      {children}
    </Context.Provider>
  );
}

export function useContext() {
  const context = useContext(Context);
  if (!context) {
    throw new Error('useContext must be used within ContextProvider');
  }
  return context;
}
```

## ğŸ¯ REACT QUERY RULES COMPLÃˆTES
```typescript
// âœ… Configuration centralisÃ©e
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 0,                    // Toujours refetch
      refetchOnMount: true,           // Refetch au montage
      placeholderData: (prev) => prev // Garde donnÃ©es pendant refetch
    }
  }
});

// âœ… Query Keys hiÃ©rarchiques
export const queryKeys = {
  workspace: {
    all: ['workspaces'] as const,
    detail: (id: string) => ['workspace', id] as const,
    domain: (id: string) => ['workspace', id, 'domain'] as const
  },
  domain: {
    byAgent: (agentId: string) => ['domain', agentId] as const
  }
};

// âœ… Mutations avec mise Ã  jour cache
onSuccess: (newData) => {
  queryClient.setQueryData(queryKey, newData);
}
```

## ğŸ“Š PERFORMANCE FRONTEND
- âœ… **useCallback** pour handlers avec dÃ©pendances
- âœ… **useMemo** pour calculs coÃ»teux uniquement
- âœ… **React.memo** pour composants avec props stables
- âœ… **React.lazy** pour gros composants

## ğŸ“± MOBILE & RESPONSIVE
- âœ… **Mobile-first** : Design responsive obligatoire
- âœ… **Touch targets** : Min 44px pour mobile
- âœ… **Text scaling** : Support tailles systÃ¨me
- âœ… **Loading states** : Skeleton loaders appropriÃ©s
- âœ… **Images** : Formats optimisÃ©s (WebP prioritÃ©)
- âœ… **Lazy loading** : Composants hors viewport
- âœ… **Bundle size** : React.lazy pour gros modules
- âœ… **Cache** : Persistance React Query locale

## ğŸ”§ ERROR HANDLING FRONTEND
```typescript
// âœ… Gestion dans hooks
try {
  const result = await service.method();
  return result;
} catch (error) {
  throw error; // Laisser React Query gÃ©rer
}

// âœ… Display dans composants
if (isError) {
  return <ErrorComponent error={error} />;
}
```

## ğŸ—ï¸ ARCHITECTURE MODULES FRONTEND OBLIGATOIRE

### âœ… Structure modules : L'essentiel tourne autour des modules (comme des apps)
```
client/
â”œâ”€â”€ modules/                    # Modules = mini-apps complÃ¨tes
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ BaseModule.tsx      # Interface de base pour tous les modules
â”‚   â”‚   â””â”€â”€ ModuleRegistry.ts   # Registre centralisÃ© des modules
â”‚   â”œâ”€â”€ ChatModule.tsx          # Module Chat IA
â”‚   â”œâ”€â”€ SavCustomAgentModule.tsx    # Module Agent SAV
â”‚   â”œâ”€â”€ SalesCustomAgentModule.tsx  # Module Agent Sales
â”‚   â”œâ”€â”€ ImageGenerationModule.tsx   # Module GÃ©nÃ©ration d'images
â”‚   â”œâ”€â”€ CampaignModule.tsx          # Module Campagnes
â”‚   â”œâ”€â”€ ReplyModule.tsx             # Module RÃ©ponses automatiques
â”‚   â””â”€â”€ BaseCustomAgentModule.tsx   # Module de base pour agents
â”œâ”€â”€ components/                 # Composants par domaine (utilisÃ©s par modules)
â”‚   â”œâ”€â”€ chat/                   # Composants spÃ©cifiques au chat
â”‚   â”œâ”€â”€ custom-agent/           # Composants pour agents personnalisÃ©s
â”‚   â”œâ”€â”€ campaign/               # Composants pour campagnes
â”‚   â”œâ”€â”€ reply/                  # Composants pour rÃ©ponses
â”‚   â”œâ”€â”€ ui/                     # Composants UI rÃ©utilisables
â”‚   â””â”€â”€ module/                 # Composants de structure des modules
â””â”€â”€ app/                        # Routes Next.js
    â””â”€â”€ dashboard/
        â””â”€â”€ employees/[name]/[module]/page.tsx  # Route dynamique pour modules
```

### âœ… Pattern Module obligatoire
```typescript
// âœ… Chaque module doit implÃ©menter ModuleComponent
import { createModule, ModuleComponent } from './core/BaseModule';

const MyModule: ModuleComponent = ({ employee, onModuleChange }) => {
  // âœ… Interface standardisÃ©e pour tous les modules
  return (
    <div>
      {/* Contenu du module utilisant des composants */}
    </div>
  );
};

export default createModule(MyModule);
```

### âœ… Registry des modules
```typescript
// âœ… Pattern dÃ©tectÃ© dans ModuleRegistry.ts
const modulesComponents: Record<string, ModuleComponent> = {
  'chat': ChatModule,
  'sav-custom-agent': SavCustomAgentModule,
  'sales-custom-agent': SalesCustomAgentModule,
  'image-generation': ImageGenerationModule,
  'campaign': CampaignModule,
  'reply': ReplyModule
};

export const getModule = (moduleId: string): ModuleComponent | undefined => {
  return modulesComponents[moduleId];
};
```

### âœ… Route dynamique des modules
```typescript
// âœ… Pattern dÃ©tectÃ© dans page.tsx
export default function EmployeeModulePage({ params }: PageProps) {
  const moduleComponent = getModule(moduleId);
  
  if (moduleComponent) {
    return <ActiveModule employee={employee} onModuleChange={handleModuleChange} />;
  }
  
  // Fallback vers chat si module inexistant
  router.push(`/dashboard/employees/${employeeName}/chat`);
}
```

## ğŸ“ ORGANISATION SERVICES FRONTEND OBLIGATOIRE

### âœ… Structure directories services
```
client/services/
â”œâ”€â”€ api/           # Services mÃ©tier connectÃ©s aux APIs externes
â”‚   â”œâ”€â”€ sessionService.ts      # Service IA/Chat (spÃ©cial FastAPI)
â”‚   â”œâ”€â”€ documentService.ts     # Gestion documents
â”‚   â”œâ”€â”€ customAgentService.ts  # Agents personnalisÃ©s
â”‚   â”œâ”€â”€ campaignService.ts     # Campagnes marketing
â”‚   â”œâ”€â”€ automationService.ts   # Automations
â”‚   â””â”€â”€ firebase/             # Configuration Firebase
â”‚       â”œâ”€â”€ config.ts         # Configuration environnement
â”‚       â”œâ”€â”€ functions.ts      # Wrapper fonctions Firebase
â”‚       â””â”€â”€ index.ts          # Exports centralisÃ©s
â””â”€â”€ local/         # Services utilitaires locaux (pas d'API)
    â”œâ”€â”€ authenticationService.ts  # Auth + tokens + firewall
    â”œâ”€â”€ dateService.ts           # Formatage dates
    â”œâ”€â”€ fileProcessingService.ts # Validation fichiers
    â”œâ”€â”€ mimeTypeService.ts       # Types MIME
    â””â”€â”€ dataExportService.ts     # Export donnÃ©es
```

### âœ… RÃ¨gles placement services
- âœ… **Services API** â†’ `client/services/api/` : ConnectÃ©s aux APIs (Firebase, FastAPI, externes)
- âœ… **Services locaux** â†’ `client/services/local/` : Utilitaires purs, pas d'appels rÃ©seau
- âœ… **Configuration** â†’ `client/services/api/firebase/` : Configuration environnement Firebase
- âŒ **JAMAIS** mÃ©langer local et API dans le mÃªme rÃ©pertoire

### âœ… RÃ¨gles modules vs composants
- âœ… **Modules** â†’ `client/modules/` : Mini-apps complÃ¨tes avec logique mÃ©tier
- âœ… **Composants** â†’ `client/components/` : Composants rÃ©utilisables par domaine utilisÃ©s par les modules
- âœ… **Routes** â†’ `client/app/` : Routes Next.js qui chargent les modules dynamiquement
- âŒ **JAMAIS** mÃ©langer logique mÃ©tier dans les composants (utiliser modules)

## ğŸ¤– SERVICE IA SPÃ‰CIAL : sessionService.ts

### âœ… SessionService - Service IA critique
```typescript
// âœ… Pattern spÃ©cial pour l'IA : connexion directe FastAPI
export class SessionService {
  // âœ… Constantes pour messages spÃ©ciaux
  public static readonly SAVED_IMPORTANT_INFO_BDD = "saved_important_info:";
  public static readonly SAVED_IMPORTANT_INFO_LIVE = "temp:saved_important_info";

  // âœ… Streaming SSE obligatoire pour IA
  static async createSessionAndSendMessage(
    appName: string,
    parts: (MessageText | MessageFile)[],
    workspaceId: string,
    sessionId: string
  ): Promise<{ stream: ReadableStream }> {
    // âœ… Appel direct FastAPI (pas Firebase)
    const response = await fetch(`${SERVICE_URL.FASTAPI}/run_sse/new_session`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${idToken}`
      },
      body: JSON.stringify({
        app_name: appName,
        session_id: sessionId,
        workspace_id: workspaceId,
        new_message: { role: 'user', parts },
        streaming: true
      })
    });
    return { stream: response.body };
  }
}
```

### âœ… Patterns SessionService obligatoires
- âœ… **FastAPI direct** : `SERVICE_URL.FASTAPI` pour IA (pas Firebase)
- âœ… **Streaming SSE** : ReadableStream pour rÃ©ponses temps rÃ©el
- âœ… **Auth Bearer** : Token Firebase dans Authorization header
- âœ… **Gestion partielle** : Messages `partial: true` pour streaming
- âœ… **Constantes messages** : SAVED_IMPORTANT_INFO_* pour types spÃ©ciaux
- âœ… **Error handling** : Timeout 20s + gestion erreurs stream

### âœ… SSE Stream handling pattern
```typescript
// âœ… Pattern obligatoire pour gÃ©rer les streams IA
static async handleSSEStream(
  stream: ReadableStream,
  onMessage: (message: Message) => void,
  onComplete: (sessionId: string, workspaceId: string, titleSession: string) => void,
  onError: (error: Error) => void
) {
  const reader = stream.getReader();
  const decoder = new TextDecoder();
  let buffer = '';
  let currentMessage: Message | null = null;
  let hasReceivedFirstMessage = false;

  try {
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      let boundary = buffer.indexOf("\n\n");
      
      while (boundary !== -1) {
        const chunk = buffer.slice(0, boundary).trim();
        buffer = buffer.slice(boundary + 2);

        if (chunk.startsWith('data:')) {
          const rawData = chunk.replace(/^data:\s*/, '');
          const data = JSON.parse(rawData);
          
          // GÃ©rer messages partiels et complets
          if (data.partial) {
            if (currentMessage) {
              currentMessage.text += text;
            } else {
              currentMessage = {
                id: data.id,
                author: 'agent',
                text: text,
                timestamp: new Date(data.timestamp),
                partial: true
              };
            }
            onMessage(currentMessage);
          }
        }
        boundary = buffer.indexOf("\n\n");
      }
    }
  } finally {
    reader.releaseLock();
  }
}
```

## ğŸ”’ SERVICE AUTHENTIFICATION SPÃ‰CIAL : authenticationService.ts

### âœ… AuthenticationService - Service sÃ©curitÃ© critique
```typescript
// âœ… Pattern spÃ©cial : Firewall + tokens + multi-environment
export class AuthenticationService {
  // âœ… Firewall obligatoire contre spam
  const requestFirewall = new Map<string, FirewallEntry>();
  const MAX_REQUESTS_PER_ENDPOINT = 10;
  const FIREWALL_RESET_TIME = 10000; // 10 secondes
  
  // âœ… Wrapper sÃ©curisÃ© obligatoire
  export async function callSecuredFunction<T>(
    functionName: string,
    workspaceId: string,
    data?: any
  ): Promise<T> {
    // 1ï¸âƒ£ Firewall check
    if (!checkFirewall(functionName)) {
      throw new Error(`ğŸš¨ PAREFEU: Trop de requÃªtes pour ${functionName}`);
    }

    // 2ï¸âƒ£ Token workspace
    const workspace_tokens = getStoredTokens();
    const workspaceToken = workspace_tokens[workspaceId];

    // 3ï¸âƒ£ Appel Firebase avec token
    const result = await callFirebaseFunction<T & { workspace_tokens?: WorkspaceTokenMap }>(
      functionName, 
      { ...data, workspaceToken: workspaceToken?.token || null }
    );

    // 4ï¸âƒ£ Mise Ã  jour tokens si reÃ§us
    if (result.workspace_tokens) {
      storeTokens(result.workspace_tokens);
    }

    return result;
  }
}
```

### âœ… Patterns AuthenticationService obligatoires
- âœ… **Firewall systÃ¨me** : Protection contre spam (10 req/10s par endpoint)
- âœ… **Multi-environment** : URLs diffÃ©rentes dev/staging/prod
- âœ… **Token management** : localStorage + workspace isolation
- âœ… **Auto-logout** : Erreurs INVALID_TOKEN â†’ dÃ©connexion automatique
- âœ… **Error notification** : ROLE_NOT_ALLOWED â†’ notification utilisateur
- âœ… **Cache clearing** : clearAllCache() sur dÃ©connexion

## ğŸŒ RÃˆGLES URLS ENVIRONNEMENTS


### âœ… RÃ¨gles URLs obligatoires
- âœ… **Firebase dev** : us-central1 (Ã©mulateurs)
- âœ… **Firebase prod** : europe-west1 (production)
- âœ… **FastAPI local** : 127.0.0.1:8080 si NEXT_PUBLIC_FASTAPI_ENV=local
- âœ… **FastAPI staging** : Google Cloud Run staging
- âœ… **FastAPI prod** : api.demo-project.com
- âŒ **JAMAIS** hardcoder URLs sans vÃ©rification environnement

## ğŸª HOOKS RULES STRICTES

### âœ… UN HOOK DOIT ÃŠTRE UN HOOK
- âœ… **React Hook uniquement** : Pas de classes, pas de fonctions utilitaires dÃ©guisÃ©es
- âœ… **React Query OBLIGATOIRE** : Pas de useState/useEffect manuels pour donnÃ©es API
- âœ… **Return organisÃ©** : Data/Loading states/Actions/Utils
- âœ… **useCallback stabilisÃ©** : TOUS les handlers DOIVENT Ãªtre stabilisÃ©s

### âŒ ANTI-PATTERNS HOOKS INTERDITS
```typescript
// âŒ INTERDIT - Hook qui n'est pas un hook
export function useCustomAgentNotifications() {
  const [data, setData] = useState(); // âŒ Ã‰tat manuel
  const [loading, setLoading] = useState();
  
  useEffect(() => { // âŒ Effect manuel pour API
    fetchData().then(setData);
  }, []);
  
  return { data, loading }; // âŒ Return non organisÃ©
}

// âŒ INTERDIT - Handler non stabilisÃ©
const handleClick = () => { // âŒ Pas de useCallback
  doSomething();
};
```

### âœ… HOOK PATTERN CORRECT OBLIGATOIRE
```typescript
// âœ… CORRECT - Hook React Query
export function useCustomAgentNotifications(customAgentId: string) {
  const { currentWorkspaceId } = useWorkspaceContext();
  const queryClient = useQueryClient();

  // âœ… React Query pour donnÃ©es
  const notificationsQuery = useQuery({
    queryKey: queryKeys.customAgentNotifications(currentWorkspaceId, customAgentId),
    queryFn: async () => {
      const result = await CustomAgentNotificationService.getNotifications(currentWorkspaceId);
      return result.notifications.filter(n => n.custom_agent_id === customAgentId);
    },
    staleTime: 0,
    refetchOnMount: true,
    placeholderData: (previousData) => previousData
  });

  // âœ… Mutations avec cache
  const createOrUpdateMutation = useMutation({
    mutationFn: ({ config }: { config: CustomAgentNotificationConfig }) =>
      CustomAgentNotificationService.createOrUpdate(currentWorkspaceId, customAgentId, config),
    onSuccess: () => {
      queryClient.invalidateQueries({
        queryKey: queryKeys.customAgentNotifications(currentWorkspaceId, customAgentId)
      });
    }
  });

  // âœ… Handlers stabilisÃ©s avec useCallback
  const createOrUpdateNotification = useCallback((config: CustomAgentNotificationConfig) => {
    createOrUpdateMutation.mutate({ config });
  }, [createOrUpdateMutation]);

  const refresh = useCallback(async () => {
    await queryClient.invalidateQueries({
      queryKey: queryKeys.customAgentNotifications(currentWorkspaceId, customAgentId)
    });
  }, [currentWorkspaceId, customAgentId, queryClient]);

  // âœ… Return organisÃ© par catÃ©gorie
  return {
    // Data
    notification: notificationsQuery.data?.[0] || null,
    notifications: notificationsQuery.data || [],
    // Loading states
    isLoading: notificationsQuery.isLoading,
    isError: notificationsQuery.isError,
    error: notificationsQuery.error,
    // Actions
    createOrUpdateNotification,
    isCreatingOrUpdating: createOrUpdateMutation.isPending,
    // Utils
    refresh
  };
}
```

## ğŸª PATTERNS HOOKS DÃ‰TECTÃ‰S

### âœ… Singleton managers dans hooks
```typescript
// âœ… Pattern dÃ©tectÃ© dans useAutomations.ts
class RefreshTimeManager {
  private static instance: RefreshTimeManager;
  private lastRefreshTime: Date | null = null;

  private constructor() {}

  static getInstance(): RefreshTimeManager {
    if (!RefreshTimeManager.instance) {
      RefreshTimeManager.instance = new RefreshTimeManager();
    }
    return RefreshTimeManager.instance;
  }
}
```

### âœ… Configuration React Query spÃ©cifique
```typescript
// âœ… Pattern dÃ©tectÃ© : staleTime variables selon contexte
const query = useQuery({
  queryKey: queryKeys.domain(workspaceId),
  queryFn: () => Service.method(workspaceId),
  staleTime: 5 * 60 * 1000, // âœ… 5 min pour automations
  retry: false, // âœ… DÃ©sactivÃ© pour workspaces
  placeholderData: (previousData) => previousData // âœ… TOUJOURS garder donnÃ©es
});
```

### âœ… Cache management optimisÃ©
```typescript
// âœ… Pattern dÃ©tectÃ© dans useCampaigns.ts
const updateItemInCache = (updatedItem: ItemType) => {
  queryClient.setQueryData<InfiniteData<ResponseType>>(
    queryKey,
    (old) => {
      if (!old) return {
        pages: [{ items: [updatedItem], hasMore: false, nextCursor: null }],
        pageParams: [undefined]
      };
      return {
        ...old,
        pages: old.pages.map(page => ({
          ...page,
          items: page.items.map(item => 
            item.id === updatedItem.id ? updatedItem : item
          )
        }))
      };
    }
  );
};
```

## âš›ï¸ PATTERNS COMPOSANTS DÃ‰TECTÃ‰S

### âœ… Enum local dans composants
```typescript
// âœ… Pattern dÃ©tectÃ© dans CampaignCreation.tsx
enum Step {
  WELCOME = 'welcome',
  IMAGES = 'images', 
  DESCRIPTION = 'description',
  GENERATION = 'generation'
}
```

### âœ… Interfaces props explicites
```typescript
// âœ… Pattern obligatoire dÃ©tectÃ©
interface ComponentProps {
  onBack: () => void;
  employeeRgba: string;
  onCampaignGenerated: (campaign: Campaign) => void;
}

export const Component: React.FC<ComponentProps> = ({ 
  onBack, 
  employeeRgba, 
  onCampaignGenerated 
}) => {
  // Implementation
};
```

## ğŸ›ï¸ PATTERNS CONTEXTS DÃ‰TECTÃ‰S

### âœ… Setters stabilisÃ©s obligatoires
```typescript
// âœ… Pattern dÃ©tectÃ© dans ChatParamsContext.tsx
const stableSetValue = React.useCallback((value: string | null) => {
  setValue(value);
}, []);

return (
  <Context.Provider value={{ 
    value, 
    setValue: stableSetValue // âœ… TOUJOURS setter stabilisÃ©
  }}>
    {children}
  </Context.Provider>
);
```

## ğŸ¨ PATTERNS UI DÃ‰TECTÃ‰S

### âœ… Utilisation React Icons
```typescript
// âœ… Pattern dÃ©tectÃ© dans tous les composants
import { RiAttachment2, RiBrainLine } from 'react-icons/ri';
import { FiImage, FiFile, FiShield, FiAlertCircle } from 'react-icons/fi';

// Usage avec classes Tailwind
<RiAttachment2 className="w-5 h-5" />
```

### âœ… DateService usage
```typescript
// âœ… Pattern dÃ©tectÃ© dans ChatInterface.tsx
import { DateService } from '@/services/local/dateService';

const formattedDate = DateService.formatChatDate(date);
```

### âœ… FileProcessingService usage
```typescript
// âœ… Pattern dÃ©tectÃ©
import { FileProcessingService, FileValidationConfigType } from '@/services/local/fileProcessingService';

const result = await FileProcessingService.process(file, {
  preset: FileValidationConfigType.documentBrain
});
```

## ğŸ”„ NOUVELLES RÃˆGLES IDENTIFIÃ‰ES

### âš ï¸ Singleton managers dans hooks autorisÃ©s
- âœ… **RefreshTimeManager pattern** : Acceptable pour gÃ©rer l'Ã©tat persistant dans hooks
- âœ… **getInstance() method** : Pattern singleton acceptable dans hooks spÃ©cifiques

### âš ï¸ Configuration React Query adaptative
- âœ… **staleTime variable** : Adapter selon le contexte (5min automations, 0 workspaces)
- âœ… **retry: false** : DÃ©sactiver pour certaines queries critiques
- âœ… **placeholderData mandatory** : TOUJOURS garder donnÃ©es pendant refetch

### âš ï¸ Cache management patterns obligatoires
- âœ… **InfiniteData handling** : Pattern spÃ©cifique pour pagination
- âœ… **Fallback data structure** : TOUJOURS prÃ©voir structure vide si pas de donnÃ©es

## ğŸ“… RÃˆGLES DATE MANAGEMENT OBLIGATOIRES

### âœ… DateService centralisÃ© pour toutes les dates
```typescript
// âœ… TOUJOURS utiliser DateService
import { DateService } from '@/services/local/dateService';

// âŒ INTERDIT - CrÃ©er des fonctions de date locales
const formatDate = (date: Date) => { /* ... */ };

// âœ… OBLIGATOIRE - Utiliser le service centralisÃ©
const formattedDate = DateService.formatChatDate(date);
```

### âœ… Normalisation dates pour cache React Query
```typescript
// âœ… Pattern pour Ã©viter requÃªtes multiples inutiles
import { DateService } from '@/services/local/dateService';

// Normaliser les dates Ã  minuit GMT pour cache stable
const normalizedDate = DateService.normalizeToMidnightGMT(date);

// Dates normalisÃ©es pour clÃ© de cache stable
const normalizedStart = DateService.normalizeToMidnightGMT(startDate);
const normalizedEnd = DateService.normalizeToMidnightGMT(endDate);

// Query avec clÃ© stable
const query = useQuery({
  queryKey: queryKeys.domain.stats(id, normalizedStart, normalizedEnd), // âœ… ClÃ© stable
  // âŒ INTERDIT: queryKey avec Date objects directs
  // queryKey: queryKeys.domain.stats(id, startDate, endDate)
});
```

### âœ… Services de date disponibles dans DateService
```typescript
// âœ… MÃ©thodes disponibles Ã  utiliser
DateService.formatChatDate(date)           // Chat/sessions
DateService.formatSessionDate(date)        // Historique sessions  
DateService.formatTimeSince(date)          // "Il y a X min/h/jours"
DateService.convertGMTToLocal(gmtTime)     // GMT -> local
DateService.convertLocalToGMT(localTime)   // Local -> GMT
DateService.normalizeToMidnightGMT(date)   // Cache normalisÃ©
```

### âŒ Anti-patterns date interdits
```typescript
// âŒ INTERDIT - Date locale sans normalisation
const query = useQuery({
  queryKey: ['stats', new Date()], // Cache cassÃ©
});

// âŒ INTERDIT - Formatage date local
const formatDate = (date: Date) => {
  return date.toLocaleDateString(); // Utiliser DateService
};

// âŒ INTERDIT - ClÃ©s cache instables
const queryKey = [agentId, dateRange.start, dateRange.end]; // Objets Date
```

### ğŸ¯ Cache performance optimisÃ©
- âœ… **Dates normalisÃ©es** : MÃªme pÃ©riode = mÃªme clÃ© cache
- âœ… **GMT+0 minuit** : `00:00:00.000Z` pour cohÃ©rence
- âœ… **ClÃ© format** : `"2024-01-15_2024-02-15"` (stable)
- âœ… **StaleTime adaptÃ©** : 12h pour stats, 0 pour donnÃ©es temps rÃ©el